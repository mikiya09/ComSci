
# &#x250f; Setup 

[`mongoBD`](https://www.mongodb.com)

#### &#x2314; Local Environment
**`+ create a cluster`**
```
1) plans:                   shared if don't want to pay
2) services:                choose AWS or Googld Cloud are fine
3) region:                  where close to your main usage place
4) cluster name:            whatever you want
5) username and password:   autogenerate if using local env for connection 
6) IP address:              add your current IP address
```
#### &#x2314; Cloud Environment
`...`

#### &#x2314; Cluster 
```
something on top of the database, you can think of that database is inside the cluster
```
### &#x2317; Connection
#### &#x2314; through GUI
```
1) click database tab on the left
2) click into the cluster just created
3) click connect -> connect your application -> select python -> select version
4) copy the connection string autogenerated
# mongodb+srv://mikiya:<password>@test01.ydhguxj.mongodb.net/?retryWrites=true&w=majority 
```
#### &#x2314; through mongocli (command line)
`...`

#### &#x2314; mongoDB compass
```
1) go to cluster and click connect 
2) select connect using MongoBD Compass 
3) download and install 
4) copy the connection string and open mongoBD compass 
# mongodb+srv://mikiya:<password>@test01.ydhguxj.mongodb.net/test

5) go to new connection -> copy in the link and replace the password field
6) connect
# now you can create database 

7) create database -> name your database -> name your collection (two different name for db and collections)
```
#### &#x2314; Document Model 
##### *`+ model`*
<img src="./pic/documentModel.png" width=500>

##### *`+ each collection could contain many documents with/without same schema`*
<img src="./pic/documentModel2.png" width=500>

#### &#x2314; Connect
##### &#x21e2; dependencies
```python
# for mongoDB
pip install pymongo 

# for work with dot file in python 
pip install python-dotenv
```

##### &#x21e2; connection file
**`.env`**
```
# for accessibility, you have to give permission for IP address as well as the password
MONGODB_PWD = ""
```

**`connection.py`**
```python 
from dotenv import load_dotenv, find_dotenv
import os
import pprint 
from pymongo import MongoClient 
# create a .env file within the same directory
load_dotenv(find_dotenv())


# connection setup
password = os.environ.get("MONGODB_PWD")
# remember to replace the password field
connection_string = f"mongodb+srv://mikiya:{password}@test01.ydhguxj.mongodb.net/?retryWrites=true&w=majority"

client = MongoClient(connection_string)

# collect all the database inside 
dbs = client.list_database_names()
# specific database with their name 
test_db = client.test
# check collections in a database 
collections = test_db.list_collection_names()
# print them
print(dbs)
print(collections)
```
# &#x250f; Operations
**[`code`](./code/basic_query.py)**
```
basic queries: 

1) connect 
2) insert 
3) create collection 
4) read 
5) update
6) delete
```

### &#x2317; Schema Validation
#### &#x2314; Admin Access 
```
When execute command like "collMod", or something involves valiadtor I assume, you have to change permission 
                          ----------                                                              ----------

1) open cluster 
    -> security on the left tab 
    -> click Database Access 
2) click edit 
    -> click built-in Role 
    -> select Atlas admin giving access
    -> update user (other users are also given permission here)
3) configure connection string 
    -> make sure we are authenticating as admin, which doesn't happen by default
    -> mongodb+srv://mikiya:{password}@test01.ydhguxj.mongodb.net/?retryWrites=true&w=majority&authSource=admin
    -> run the valiadtor code and check it on the validation tab
4) if bad auth happen it might because you have change password, but did not specify at compass connection
5) if you want to add null values, you have to specify in validation
```
<img src="./pic/accessAdmin.png" width=800>

**[`+ example`](./code/advanced_queries.py): for some reason schema validation is not working properly for my 
author collections, so I turn that validation level from to "strict" to "off", but book validation works fine,
I guess it might cause by some unknown reason that I don't need to care for right now**
```python
# json file that specify the requirement for values fields in the schema for collections
#                                            |
#                                            v 
# same as value constraint in relational database when you declare an attribute

# code
book_validator = {
        "$jsonSchema": {
            "bsonType": "object",
            "required": ["title", "authors", "publish_date", "type", "copies"],
            "properties": {
                "title": {
                    "bsonType": "string",
                    "description": "must be a string and is required"
                },
                "authors": {
                    "bsonType": "array",
                    "items": {
                        "bsonType": "objectId",
                        "description": "must be an objectid and is required"
                    }
                },
                "publish_data": {
                    "bsonType": "date",
                    "description": "must be a date and is required"
                },
                "type": {
                    "enum": ["Fiction", "Non-Fiction"],
                    "description": "can only be one of the enum values and is required"
                },
                "copies": {
                    "bsonType": "int",
                    "minimum": 0,
                    "description": "must be an integer greater than 0 and is required"
                },
            }
        }
    }

try: 
    production.create_collection("book")
except Exception as e:
    print(e)

production.command("collMod", "book", validator=book_validator)
```
### &#x2317; Data Modeling
#### &#x2314; Embedded Document Pattern
```python
# if we modeling One-to-One relationship, it's fast using embedded
# ------------------------------------------------------------------

# patron document
{
   _id: "joe",
   name: "Joe Bookreader"
}

# address document
{
   patron_id: "joe", # reference to patron document
   street: "123 Fake Street",
   city: "Faketon",
   state: "MA",
   zip: "12345"
}

# embedded
# ------------------------------------------------------------------
{
   _id: "joe",
   name: "Joe Bookreader",
   address: {
              street: "123 Fake Street",
              city: "Faketon",
              state: "MA",
              zip: "12345"
            }
}
```
#### &#x2314; Reference Patterns 
```python 
# it's always good to use reference pattern because large database has One-to-Many or Many-to-Many
# ------------------------------------------------------------------------------------------------
{
   title: "MongoDB: The Definitive Guide",
   author: [ "Kristina Chodorow", "Mike Dirolf" ],
   published_date: ISODate("2010-09-24"),
   pages: 216,
   language: "English",
   publisher: {
              name: "O'Reilly Media",
              founded: 1980,
              location: "CA"
            }
}

{
   title: "50 Tips and Tricks for MongoDB Developer",
   author: "Kristina Chodorow",
   published_date: ISODate("2011-05-06"),
   pages: 68,
   language: "English",
   publisher: {
              name: "O'Reilly Media",
              founded: 1980,
              location: "CA"
            }
}

# reference patterns 
# ------------------------------------------------------------------------------------------------
{
   name: "O'Reilly Media",
   founded: 1980,
   location: "CA",
   books: [123456789, 234567890, ...]
}

{
    _id: 123456789,
    title: "MongoDB: The Definitive Guide",
    author: [ "Kristina Chodorow", "Mike Dirolf" ],
    published_date: ISODate("2010-09-24"),
    pages: 216,
    language: "English"
}

{
   _id: 234567890,
   title: "50 Tips and Tricks for MongoDB Developer",
   author: "Kristina Chodorow",
   published_date: ISODate("2011-05-06"),
   pages: 68,
   language: "English"
}
```
**`we reference authors in book collection in our example`** <br>

<img src="./pic/bookData.png" width=400>
<img src="./pic/authorData.png" width=400>

### &#x2317; Advanced Queries
```
# google for reference

1) $regex 
2) $lookup 
3) ...
```
### &#x2317; Pymongo Arrow
[`package`](https://mongo-arrow.readthedocs.io/en/latest/quickstart.html)
```python
# install dependencies
pip install jupyter pymongoarrow pymongo pandas numpy
```
```python 
import pyarrow 
from pymongoarrow.api import Schema 
from pymongoarrow.monkey import patch_all
import pymongoarrow as pma 

# patch all the apis that work with mongodb's collections, just make sure you run this command 
patch_all()

# specify attributes that you want to get 
author = Schema({"_id": ObjectId, "first_name": pyarrow.string(),
                 "last_name": pyarrow.string(), "date_of_birth": dt})

# pandas dataframe 
# remember production = client.production
df = production.author.find_pandas_all({}, schema=author)   # id is in binary form

# arrow table is what all attributes collected into a list 
arrow_table = production.author.find_arrow_all({}, schema=author)

# array 
ndarrays = production.author.find_numpy_all({}, schema=author)

print(df)
```



